Return-Path: <io-uring-owner@vger.kernel.org>
X-Original-To: lists+io-uring@lfdr.de
Delivered-To: lists+io-uring@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id 01006167E40
	for <lists+io-uring@lfdr.de>; Fri, 21 Feb 2020 14:17:21 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727053AbgBUNRS (ORCPT <rfc822;lists+io-uring@lfdr.de>);
        Fri, 21 Feb 2020 08:17:18 -0500
Received: from mail-qv1-f52.google.com ([209.85.219.52]:42258 "EHLO
        mail-qv1-f52.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1728300AbgBUNRR (ORCPT
        <rfc822;io-uring@vger.kernel.org>); Fri, 21 Feb 2020 08:17:17 -0500
Received: by mail-qv1-f52.google.com with SMTP id dc14so946308qvb.9
        for <io-uring@vger.kernel.org>; Fri, 21 Feb 2020 05:17:16 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=scylladb-com.20150623.gappssmtp.com; s=20150623;
        h=mime-version:from:date:message-id:subject:to;
        bh=cQ9Z8lb6ALwbwNJQ49eWfbgNtxEpXerq+TtFuIm+Exs=;
        b=rz7zzZxs7OPKNXS+kC+s1gNhW5R0DYBIppRY44T2EBqWxBmtqAlPn1SllGx/OO6Oq6
         ClespWUCzopjJRbSKqPoQgvixXjQqCuh9DSCV3Qk0IQ/IPEsMcq4y7CFY2BTupHTZV8m
         8jpKEnj9XPxK9P34X2ii5UinjPEvzg1LN3IbhHa2oJGTJpGY2sdPcok6C+bZYP9mYLoo
         /hGDY7Ddnesh4fl3gjjc9XwZEuWJq0aJNBDUqJiuSdONrsFVlwSk5ORhtVDTYLAQqX1K
         PARlpWSdWXC72jUokBYi+OWu+84mDZ5vOTfHgrU/DirUHFhkU1UarqEeUshuPshYseBk
         8HPQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:from:date:message-id:subject:to;
        bh=cQ9Z8lb6ALwbwNJQ49eWfbgNtxEpXerq+TtFuIm+Exs=;
        b=aSxf6lVjEffgCV+nAPabfCujMu9Wp8so/cGf6u4DPezdcJ63Pv8yKBxqy5sFktRDdh
         WAjrq6nt+FNqhIEIjQJlF7wV6aFihg/VUuf3NzWGibRcuQ7lBGqmefApOmXcNfalf3LC
         hRAkLGO6bcq5+B8+VUunGyYl/fr+c7a1X/LgpAkKXfqyHt4XqprGjb5YI83oZtCNrV/p
         PT0bM7ol2WIhl6dZcGpd96q/67gJRyebAXotZqaQdxN+QdoxOVHxjnhL00R6axXLWVNO
         k0FdGfyLM+y+0T/h6ZAfDByZ0cn/LOikZQKiO8EAcctTx/k+eDyS81FPUUYx98xuUoLE
         4zMg==
X-Gm-Message-State: APjAAAVtGxr/HNsdOC8HzYg8YtxvA1ykaQRoEWmn1k1qh4WxL1G2zF6T
        BtbqoDfC4gtTwXu7FoVl8WUovTvaJ7muHEjCGt5yCTdvcUljpA==
X-Google-Smtp-Source: APXvYqw5mygQr+kN/R52L/Q9MJb9w78NuPTG0GbJHCTGXCGH0NuKmWy+G+jsQFx4JQqLGP/jAtNqs0AhPzYQJdTActg=
X-Received: by 2002:a05:6214:1253:: with SMTP id q19mr29980642qvv.75.1582291035561;
 Fri, 21 Feb 2020 05:17:15 -0800 (PST)
MIME-Version: 1.0
From:   Glauber Costa <glauber@scylladb.com>
Date:   Fri, 21 Feb 2020 08:17:04 -0500
Message-ID: <CAD-J=zbKXuF1HCd5yG0oNaizNWZTD3248Oii7xoofQ--EqO3dw@mail.gmail.com>
Subject: Crash on using the poll ring
To:     io-uring@vger.kernel.org, Avi Kivity <avi@scylladb.com>,
        Jens Axboe <axboe@kernel.dk>
Content-Type: multipart/mixed; boundary="0000000000001b6cab059f15d7d3"
Sender: io-uring-owner@vger.kernel.org
Precedence: bulk
List-ID: <io-uring.vger.kernel.org>
X-Mailing-List: io-uring@vger.kernel.org

--0000000000001b6cab059f15d7d3
Content-Type: text/plain; charset="UTF-8"

Hi

Today I found a crash when adding code for the poll ring to my implementation.
Kernel is 2b58a38ef46e91edd68eec58bdb817c42474cad6

Here's how to reproduce:

code at
https://github.com/glommer/seastar.git branch poll-ring

1. same as previous steps to configure seastar, but compile with:
ninja -C build/release apps/io_tester/io_tester

2. Download the yaml file attached

3. Run with:

./build/release/apps/io_tester/io_tester --conf ~/test.yaml --duration
15 --directory /var/disk1  --reactor-backend=uring --smp 1

(directory must be on xfs because we do c++ but we're not savages)

--0000000000001b6cab059f15d7d3
Content-Type: text/plain; charset="US-ASCII"; name="poll-ring.txt"
Content-Disposition: attachment; filename="poll-ring.txt"
Content-Transfer-Encoding: base64
Content-ID: <f_k6w73ho11>
X-Attachment-Id: f_k6w73ho11

WzM1NzM5Ljc0OTU4OF0gQlVHOiBrZXJuZWwgTlVMTCBwb2ludGVyIGRlcmVmZXJlbmNlLCBhZGRy
ZXNzOiAwMDAwMDAwMDAwMDAwMDAwClszNTczOS43NDk2NTldICNQRjogc3VwZXJ2aXNvciBpbnN0
cnVjdGlvbiBmZXRjaCBpbiBrZXJuZWwgbW9kZQpbMzU3MzkuNzQ5NzA3XSAjUEY6IGVycm9yX2Nv
ZGUoMHgwMDEwKSAtIG5vdC1wcmVzZW50IHBhZ2UKWzM1NzM5Ljc0OTc1NF0gUEdEIDAgUDREIDAg
ClszNTczOS43NDk3ODZdIE9vcHM6IDAwMTAgWyMxXSBTTVAgTk9QVEkKWzM1NzM5Ljc0OTgyM10g
Q1BVOiAwIFBJRDogMTQ4NDUgQ29tbTogaW9fdGVzdGVyIE5vdCB0YWludGVkIDUuNi4wLXJjMSsg
IzE0ClszNTczOS43NDk4ODFdIEhhcmR3YXJlIG5hbWU6IEludGVsIENvcnBvcmF0aW9uIFMyNjAw
V0ZUL1MyNjAwV0ZULCBCSU9TIFNFNUM2MjAuODZCLjAyLjAxLjAwMDguMDMxOTIwMTkxNTU5IDAz
LzE5LzIwMTkKWzM1NzM5Ljc0OTk3MV0gUklQOiAwMDEwOjB4MApbMzU3MzkuNzUwMDA0XSBDb2Rl
OiBCYWQgUklQIHZhbHVlLgpbMzU3MzkuNzUwMDM2XSBSU1A6IDAwMTg6ZmZmZmI0ZTljZjM1N2Jh
OCBFRkxBR1M6IDAwMDEwMjQ2ClszNTczOS43NTAwODNdIFJBWDogMDAwMDAwMDAwMDAwMDAwMCBS
Qlg6IDAwMDAwMDAwMDAwMDAwMDAgUkNYOiAwMDAwMDAwMDAwMDAwMDAwClszNTczOS43NTAxNDhd
IFJEWDogMDAwMDAwMDAwMDAwMDAwMSBSU0k6IGZmZmY4YWYxMjA4MzA2ODAgUkRJOiBmZmZmZmZm
ZmI0MjQ4ZGUwClszNTczOS43NTAyMTFdIFJCUDogZmZmZjhiYzU5YTIzNDA3MCBSMDg6IGZmZmY4
YWYxMjA4MmI4ZDAgUjA5OiBmZmZmOGFmMTIwODJiOGQwClszNTczOS43NTAyNzJdIFIxMDogMDAw
MDAwMDAwMDAwMDMyMSBSMTE6IGZmZmY4YWYxMjA4MjljYTQgUjEyOiBmZmZmOGJjNTlhMjM0Yjc0
ClszNTczOS43NTAzMzNdIFIxMzogZmZmZjhiYzU5YTIzNDAwMCBSMTQ6IGZmZmY4YmM1OWEyMzQw
MDEgUjE1OiBmZmZmOGJjNTlkZmQzN2I4ClszNTczOS43NTAzOTddIEZTOiAgMDAwMDdmMTUwYjZm
OTkwMCgwMDAwKSBHUzpmZmZmOGFmMTIwODAwMDAwKDAwMDApIGtubEdTOjAwMDAwMDAwMDAwMDAw
MDAKWzM1NzM5Ljc1MDQ2NV0gQ1M6ICAwMDEwIERTOiAwMDAwIEVTOiAwMDAwIENSMDogMDAwMDAw
MDA4MDA1MDAzMwpbMzU3MzkuNzUwNTE4XSBDUjI6IGZmZmZmZmZmZmZmZmZmZDYgQ1IzOiAwMDAw
MDBlN2RkNjBhMDA1IENSNDogMDAwMDAwMDAwMDc2MDZmMApbMzU3MzkuNzUwNTgxXSBEUjA6IDAw
MDAwMDAwMDAwMDAwMDAgRFIxOiAwMDAwMDAwMDAwMDAwMDAwIERSMjogMDAwMDAwMDAwMDAwMDAw
MApbMzU3MzkuNzUwNjQyXSBEUjM6IDAwMDAwMDAwMDAwMDAwMDAgRFI2OiAwMDAwMDAwMGZmZmUw
ZmYwIERSNzogMDAwMDAwMDAwMDAwMDQwMApbMzU3MzkuNzUwNzA1XSBQS1JVOiA1NTU1NTU1NApb
MzU3MzkuNzUwNzMyXSBDYWxsIFRyYWNlOgpbMzU3MzkuNzUwNzY4XSAgX190YXNrX3dvcmtfcnVu
KzB4NjcvMHhhMApbMzU3MzkuNzUwODExXSAgc2NoZWR1bGUrMHhiMS8weGYwClszNTczOS43NTA4
NDVdICBzY2hlZHVsZV90aW1lb3V0KzB4MjBmLzB4MzAwClszNTczOS43NTA4ODZdICA/IF9fa2Zp
Zm9fdG9fdXNlcl9yKzB4OTAvMHg5MApbMzU3MzkuNzUwOTI3XSAgPyBfX3BlcmNwdV9yZWZfc3dp
dGNoX21vZGUrMHhkNy8weDE5MApbMzU3MzkuNzUwOTc2XSAgPyBfX3dha2VfdXBfY29tbW9uX2xv
Y2srMHg4YS8weGMwClszNTczOS43NTEwMjFdICB3YWl0X2Zvcl9jb21wbGV0aW9uKzB4MTE5LzB4
MTYwClszNTczOS43NTEwNjVdICA/IHdha2VfdXBfcSsweGEwLzB4YTAKWzM1NzM5Ljc1MTEwM10g
IGV4aXRfYWlvKzB4ZGMvMHhmMApbMzU3MzkuNzUxMTMyXSAgbW1wdXQrMHgzNS8weDE0MApbMzU3
MzkuNzUxMTYwXSAgZG9fZXhpdCsweDMwZC8weGI5MApbMzU3MzkuNzUxMTkyXSAgPyBfX21lbWNn
X2ttZW1fdW5jaGFyZ2UrMHgzNC8weGEwClszNTczOS43NTEyMzFdICBkb19ncm91cF9leGl0KzB4
M2EvMHhhMApbMzU3MzkuNzUxMjY3XSAgZ2V0X3NpZ25hbCsweDE1Yi8weDg5MApbMzU3MzkuNzUx
MzA0XSAgZG9fc2lnbmFsKzB4MzYvMHg2NTAKWzM1NzM5Ljc1MTMzOF0gID8gaW9fY3FyaW5nX3dh
aXQrMHgxZmMvMHgyMjAKWzM1NzM5Ljc1MTM3NF0gID8gaW9fdXJpbmdfcG9sbCsweDgwLzB4ODAK
WzM1NzM5Ljc1MTQxMl0gIGV4aXRfdG9fdXNlcm1vZGVfbG9vcCsweDlkLzB4MTMwClszNTczOS43
NTE0NTJdICBkb19zeXNjYWxsXzY0KzB4MWE0LzB4MWMwClszNTczOS43NTE0ODldICBlbnRyeV9T
WVNDQUxMXzY0X2FmdGVyX2h3ZnJhbWUrMHg0NC8weGE5ClszNTczOS43NTI4NjhdIFJJUDogMDAz
MzoweDdmMTUwYjdmYTFlZApbMzU3MzkuNzU0MTk1XSBDb2RlOiBCYWQgUklQIHZhbHVlLgpbMzU3
MzkuNzU1NTEzXSBSU1A6IDAwMmI6MDAwMDdmZmY5MzNhYWIzOCBFRkxBR1M6IDAwMDAwMjE2IE9S
SUdfUkFYOiAwMDAwMDAwMDAwMDAwMWFhClszNTczOS43NTY4ODVdIFJBWDogZmZmZmZmZmZmZmZm
ZmZmYyBSQlg6IDAwMDAwMDAwMDAwMDAwMDAgUkNYOiAwMDAwN2YxNTBiN2ZhMWVkClszNTczOS43
NTgyNjddIFJEWDogMDAwMDAwMDAwMDAwMDAwMSBSU0k6IDAwMDAwMDAwMDAwMDAwMDAgUkRJOiAw
MDAwMDAwMDAwMDAwMDA3ClszNTczOS43NTk2NTRdIFJCUDogMDAwMDYwMDAwMDA3NjAyMCBSMDg6
IDAwMDA2MDAwMDAwNzYwMjAgUjA5OiAwMDAwMDAwMDAwMDAwMDA4ClszNTczOS43NjEwMDVdIFIx
MDogMDAwMDAwMDAwMDAwMDAwMSBSMTE6IDAwMDAwMDAwMDAwMDAyMTYgUjEyOiAwMDAwMDAwMDAw
MDAwMDAwClszNTczOS43NjE5MDddIFIxMzogMDAwMDYwMDAwMDBjMTA2MCBSMTQ6IDAwMDAwMDAw
MDAwMDAwMDAgUjE1OiAwMDAwMDAwMDAwMDAwMDAxClszNTczOS43NjI3MjldIE1vZHVsZXMgbGlu
a2VkIGluOiBpcDZ0X1JFSkVDVCBuZl9yZWplY3RfaXB2NiBpcDZ0X3JwZmlsdGVyIGlwdF9SRUpF
Q1QgbmZfcmVqZWN0X2lwdjQgeHRfY29ubnRyYWNrIGVidGFibGVfbmF0IGVidGFibGVfYnJvdXRl
IGlwNnRhYmxlX25hdCBpcDZ0YWJsZV9tYW5nbGUgaXA2dGFibGVfcmF3IGlwNnRhYmxlX3NlY3Vy
aXR5IGlwdGFibGVfbmF0IG5mX25hdCBpcHRhYmxlX21hbmdsZSBpcHRhYmxlX3JhdyBpcHRhYmxl
X3NlY3VyaXR5IG5mX2Nvbm50cmFjayBuZl9kZWZyYWdfaXB2NiBuZl9kZWZyYWdfaXB2NCBpcF9z
ZXQgbmZuZXRsaW5rIGVidGFibGVfZmlsdGVyIGVidGFibGVzIGlwNnRhYmxlX2ZpbHRlciBpcDZf
dGFibGVzIGlwdGFibGVfZmlsdGVyIGliX2lzZXJ0IGlzY3NpX3RhcmdldF9tb2QgaWJfc3JwdCB0
YXJnZXRfY29yZV9tb2QgaWJfc3JwIHNjc2lfdHJhbnNwb3J0X3NycCBpYl9pcG9pYiB2ZmF0IGZh
dCBpYl91bWFkIHJwY3JkbWEgc3VucnBjIGludGVsX3JhcGxfbXNyIHJkbWFfdWNtIGludGVsX3Jh
cGxfY29tbW9uIGliX2lzZXIgcmRtYV9jbSBpc3N0X2lmX2NvbW1vbiBpd19jbSBpYl9jbSBsaWJp
c2NzaSBza3hfZWRhYyBzY3NpX3RyYW5zcG9ydF9pc2NzaSB4ODZfcGtnX3RlbXBfdGhlcm1hbCBp
bnRlbF9wb3dlcmNsYW1wIGNvcmV0ZW1wIGt2bV9pbnRlbCBrdm0gaXJxYnlwYXNzIGlUQ09fd2R0
IGNyY3QxMGRpZl9wY2xtdWwgaVRDT192ZW5kb3Jfc3VwcG9ydCBpNDBpdyBjcmMzMl9wY2xtdWwg
aXBtaV9zc2lmIGliX3V2ZXJicyBnaGFzaF9jbG11bG5pX2ludGVsIGludGVsX2NzdGF0ZSBpYl9j
b3JlIGludGVsX3VuY29yZSBpcG1pX3NpIGludGVsX3JhcGxfcGVyZiBqb3lkZXYgaW9hdGRtYSBt
ZWlfbWUgcGNzcGtyIHN3aXRjaHRlYyBpMmNfaTgwMSBpcG1pX2RldmludGYgbHBjX2ljaCBtZWkg
ZGNhIGRheF9wbWVtIGlwbWlfbXNnaGFuZGxlciBkYXhfcG1lbV9jb3JlIGFjcGlfcG93ZXJfbWV0
ZXIgYWNwaV9wYWQKWzM1NzM5Ljc2Mjc3NF0gIGlwX3RhYmxlcyB4ZnMgbGliY3JjMzJjIHJma2ls
bCBuZF9wbWVtIG5kX2J0dCBhc3QgaTJjX2FsZ29fYml0IGRybV92cmFtX2hlbHBlciBkcm1fdHRt
X2hlbHBlciB0dG0gZHJtX2ttc19oZWxwZXIgY2VjIGRybSBpNDBlIG52bWUgY3JjMzJjX2ludGVs
IG1lZ2FyYWlkX3NhcyBudm1lX2NvcmUgbmZpdCBsaWJudmRpbW0gd21pIHBrY3M4X2tleV9wYXJz
ZXIKWzM1NzM5Ljc3MTk2NV0gQ1IyOiAwMDAwMDAwMDAwMDAwMDAwClszNTczOS43NzI2NzVdIC0t
LVsgZW5kIHRyYWNlIGQ4ZDE2MDEzZjZmZTMyZmUgXS0tLQpbMzU3MzkuODU1NjY4XSBSSVA6IDAw
MTA6MHgwClszNTczOS44NTYyMzVdIENvZGU6IEJhZCBSSVAgdmFsdWUuClszNTczOS44NTY3NTJd
IFJTUDogMDAxODpmZmZmYjRlOWNmMzU3YmE4IEVGTEFHUzogMDAwMTAyNDYKWzM1NzM5Ljg1NzI2
NV0gUkFYOiAwMDAwMDAwMDAwMDAwMDAwIFJCWDogMDAwMDAwMDAwMDAwMDAwMCBSQ1g6IDAwMDAw
MDAwMDAwMDAwMDAKWzM1NzM5Ljg1Nzc3Ml0gUkRYOiAwMDAwMDAwMDAwMDAwMDAxIFJTSTogZmZm
ZjhhZjEyMDgzMDY4MCBSREk6IGZmZmZmZmZmYjQyNDhkZTAKWzM1NzM5Ljg1ODI4Ml0gUkJQOiBm
ZmZmOGJjNTlhMjM0MDcwIFIwODogZmZmZjhhZjEyMDgyYjhkMCBSMDk6IGZmZmY4YWYxMjA4MmI4
ZDAKWzM1NzM5Ljg1ODc4OV0gUjEwOiAwMDAwMDAwMDAwMDAwMzIxIFIxMTogZmZmZjhhZjEyMDgy
OWNhNCBSMTI6IGZmZmY4YmM1OWEyMzRiNzQKWzM1NzM5Ljg1OTI5OV0gUjEzOiBmZmZmOGJjNTlh
MjM0MDAwIFIxNDogZmZmZjhiYzU5YTIzNDAwMSBSMTU6IGZmZmY4YmM1OWRmZDM3YjgKWzM1NzM5
Ljg1OTgxNV0gRlM6ICAwMDAwN2YxNTBiNmY5OTAwKDAwMDApIEdTOmZmZmY4YWYxMjA4MDAwMDAo
MDAwMCkga25sR1M6MDAwMDAwMDAwMDAwMDAwMApbMzU3MzkuODYwMzQxXSBDUzogIDAwMTAgRFM6
IDAwMDAgRVM6IDAwMDAgQ1IwOiAwMDAwMDAwMDgwMDUwMDMzClszNTczOS44NjA4NjldIENSMjog
ZmZmZmZmZmZmZmZmZmZkNiBDUjM6IDAwMDAwMGU3ZGQ2MGEwMDUgQ1I0OiAwMDAwMDAwMDAwNzYw
NmYwClszNTczOS44NjE0MDddIERSMDogMDAwMDAwMDAwMDAwMDAwMCBEUjE6IDAwMDAwMDAwMDAw
MDAwMDAgRFIyOiAwMDAwMDAwMDAwMDAwMDAwClszNTczOS44NjE5NDddIERSMzogMDAwMDAwMDAw
MDAwMDAwMCBEUjY6IDAwMDAwMDAwZmZmZTBmZjAgRFI3OiAwMDAwMDAwMDAwMDAwNDAwClszNTcz
OS44NjI0ODFdIFBLUlU6IDU1NTU1NTU0Cgo=
--0000000000001b6cab059f15d7d3
Content-Type: application/x-yaml; name="test.yaml"
Content-Disposition: attachment; filename="test.yaml"
Content-Transfer-Encoding: base64
Content-ID: <f_k6w73hnd0>
X-Attachment-Id: f_k6w73hnd0

LSBuYW1lOiBsYXRlbmN5X3JlYWRzCiAgc2hhcmRzOiBhbGwKICB0eXBlOiByYW5kcmVhZAogIHNo
YXJkX2luZm86CiAgICBwYXJhbGxlbGlzbTogMTAKICAgIHJlcXNpemU6IDUxMgogICAgc2hhcmVz
OiAxMDAKICAgIHRoaW5rX3RpbWU6IDAKCg==
--0000000000001b6cab059f15d7d3--
